#!/usr/bin/python
#This cgi script is to generate tidal gauge pages

import os
import os.path
import re
import cgi
import cgitb
import sys
import subprocess
import urlparse
import urllib
import string

import ocean.util as util

sys.stderr = sys.stdout
cgitb.enable()

MAP_EAST_PATTERN = re.compile('east.png$')
MAP_WEST_PATTERN = re.compile('west.png$')

def main():
    config = util.get_server_config()
    form = cgi.FieldStorage()

    if "map" in form:
        queryMap = urlparse.parse_qs(os.environ["QUERY_STRING"])
        queryMap['map'] = util.get_resource('maps', form['map'].value + '.map')

        if form['map'].value in [ 'raster' ]:
            raster = form["raster"].value
            rasters = string.split(raster, " ")
            for file in rasters:
                url, filename = os.path.split(file)

                if MAP_EAST_PATTERN.search(filename):
                    queryMap["eastFileName"] = os.path.join(config['outputDir'], filename)
                elif MAP_WEST_PATTERN.search(filename):
                    queryMap["westFileName"] = os.path.join(config['outputDir'], filename)

        queryString = urllib.urlencode(queryMap, True)
        os.environ["QUERY_STRING"] = queryString
        subprocess.call(config['mapservPath'])

main()


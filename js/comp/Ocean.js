jQuery.extend({HashTable:function(){var c=[];this.toArray=function(){var a=[],b;for(b in c)a.push(c[b]);return a};this.put=function(a,b){c[a]=b};this.clear=function(a){delete c[a]};this.get=function(a){return c[a]}}});$.extend({Note:function(c,a){function b(b,a){return function(){b(a)}}var f=this,d=c,e=[];this.getId=function(){return d.note_id};this.getSubject=function(){return d.subject};this.getBody=function(){return d.body};this.setSubject=function(a){e.push(b(function(b){d.subject=b},d.subject));d.subject=a};this.setBody=function(a){e.push(b(function(b){d.body=b},d.body));d.body=a};this.update=function(b){d=$.extend(d,b)};this.confirm=function(){a.updateNote(f)};this.clearRevertActions=function(){e=[]};this.revert=
function(){for(;0<e.length;)e.pop()()}},Model:function(c){function a(a){lastLoad=a.dt;var d=[];$.each(a.notes,function(c){c=a.notes[c];var g=cache.get(c.note_id);g?g.update(c):(g=new $.Note(c,b),cache.put(c.note_id,g));d.push(g);b.notifyNoteLoaded(g)});return d}var b=this;b.cache=new $.HashTable;b.lastLoad=null;b.listeners=[];b.url=c;b.getData=function(){$.ajax({url:b.url,data:{load:!0},type:"GET",dataType:"json",timeout:1E3,error:function(){b.notifyLoadFail()},success:function(f){if(f.error)return b.notifyLoadFail();
b.notifyLoadFinish(a(f))}});return cache.toArray()};b.addNote=function(f,c){b.notifyAddingNote();$.ajax({url:"ajax.php",data:{add:!0,subject:f,body:c},type:"POST",dataType:"json",timeout:1E3,error:function(){b.notifyAddingFailed()},success:function(f){if(f.error)return b.notifyAddingFailed();b.notifyAddingFinished(a(f))}});return cache.toArray()};b.deleteNote=function(a){b.notifyDeletingNote(a);$.ajax({url:"ajax.php",data:{"delete":!0,note_id:a},type:"POST",dataType:"json",timeout:1E3,error:function(){b.notifyDeletingFailed(a)},
success:function(c){if(c.error)return b.notifyDeletingFailed(a);b.notifyDeletingFinished(a)}})};b.updateNote=function(a){b.notifySavingNote(a);$.ajax({url:"ajax.php",data:{edit:!0,note_id:a.getId(),subject:a.getSubject(),body:a.getBody()},type:"POST",dataType:"json",timeout:1E3,error:function(){b.notifySavingFailed(note_id)},success:function(c){if(c.error)return b.notifySavingFailed(a);a.update(c);b.notifySavingFinished(a)}})};b.clearAll=function(){cache=new $.HashTable};b.addListener=function(a){b.listeners.push(a)};
b.notifyLoadBegin=function(){$.each(b.listeners,function(a){b.listeners[a].loadBegin()})};b.notifyLoadFinish=function(a){$.each(b.listeners,function(c){b.listeners[c].loadFinish(a)})};b.notifyLoadFail=function(){$.each(b.listeners,function(a){b.listeners[a].loadFail()})}}});jQuery.extend({VariableModel:function(){var c=this;this.varGroupUrl="config/comp/vargroups.json";this.datasetsUrl="config/comp/datasets.json";this.getData=function(){c.notifyLoadBegin();$.when($.getJSON(this.varGroupUrl),$.getJSON(this.datasetsUrl)).done(function(a,b){c.notifyLoadFinish($.extend({},{variable:a[0]},{datasets:b[0]}))}).fail(function(){this.notifyLoadFail();fatal_error("Failed to load portal variable configuration")})}}});jQuery.extend({View:function(){function c(){var a=this.addform.find(".subject").val(),b=this.addform.find(".body").val();0==a.length?alert("Please enter a subject for your note"):that.notifyNewNote(a,b);return!1}this.doms=new $.HashTable;this.listeners=[];$notes=$("#ui #notes ul");this.addform=$("#controlPanel");this.addform.submit(c);this.addform.find("#submit").click(c);this.showAddForm=function(){$editform.hide();this.addform.show();this.addform.find(".subject").focus()};this.setAddFormEnabled=
function(a){var b=this.addform;a?b.find(".input").removeAttr("DISABLED"):b.find(".input").attr("DISABLED","1")};this.clearAddForm=function(){this.addform.find(".input").val("");this.addform.find(".subject").focus()};this.loadNote=function(a){var b=doms.get(a.getId());b?b.refresh():(b=new $.NoteLI(a,that.showEditForm),doms.put(a.getId(),b),$notes.append(b.getDOM()))};this.showNote=function(a,b){var c=doms.get(a);c&&(b?$(c.getDOM()).show():$(c.getDOM()).hide())};this.flushNote=function(a){var b=doms.get(a);
b&&$(b.getDOM()).remove();doms.clear(a)};this.addListener=function(a){this.listeners.push(a)};this.notifyDeleteNote=function(a){$.each(listeners,function(b){listeners[b].deleteNoteClicked(a)})};this.ModelListener=function(a){return $.extend({loadBegin:function(){},loadFail:function(){},loadFinish:function(a){},modelChanged:function(a){}},a)}}});jQuery.extend({NoteOption:function(c,a){var b=$("<option></option>");b.click(function(){a(c)});this.getNote=function(){return c};this.refresh=function(){b.text(c.getSubject())};this.getDOM=function(){return b};this.refresh()},DropdownView:function(){this.id="";this.getModelListener=function(){}}});jQuery.extend({VariableDropdownView:function(){var c=this;c.id="variable";c.getModelListener=function(){return c.ModelListener({loadFinish:function(a){var b={};$.each(a.variable,function(a,c){$("<optgroup>",{id:a,label:c.name}).appendTo("#variable");$.each(c.vars,function(c,d){b[d]=a})});ocean.datasets={};ocean.variables={};$.each(a.datasets,function(a,b){ocean.datasets[b.id]=b;$.each(b.variables,function(a,c){ocean.variables[c.id]||(ocean.variables[c.id]={name:c.name,plots:{},variable:c});$.each(c.plottypes,
function(a,f){ocean.variables[c.id].plots[f]||(ocean.variables[c.id].plots[f]={});$.each(c.periods,function(a,e){ocean.variables[c.id].plots[f][e]||(ocean.variables[c.id].plots[f][e]=[]);ocean.variables[c.id].plots[f][e].push(b.id)})})})});$.each(ocean.variables,function(a,c){var e;a in b?(e=$("#variable optgroup#"+b[a]),0==e.length&&(e=$("#variable"))):e=$("#variable");$("<option>",{text:c.name,value:a}).appendTo(e)})}})}}});jQuery.extend({RegionCountryModel:function(){var c=this;c.regionsUrl="cgi/regions.py";this.getData=function(){c.notifyLoadBegin();$.when($.getJSON(c.regionsUrl,{portal:"pac"})).done(function(a){c.notifyLoadFinish({regions:a})}).fail(function(){this.notifyLoadFail();fatal_error("Failed to load portal regions configuration")})}}});jQuery.extend({RegionCountryDropdownView:function(){var c=this;c.id="variable";c.getModelListener=function(){return c.ModelListener({loadFinish:function(a){a=a.regions;$.each(a,function(a,c){c.parent||$("<option>",{value:c.abbr,text:c.name}).data("extent",c.extent).appendTo("#region")});$.each(a,function(a,c){if(c.parent){var d=$('#region option[value="'+c.parent+'"]'),e=d.data("subregions")||[];e.push(c);d.data("subregions",e)}})}})};$("#region").change(function(){var a=$("#region option:selected");
0!=a.length&&($("#subregion option").remove(),$("<option>",{text:"Whole Region",value:a.val(),selected:!0}).appendTo("#subregion").data("bounds",a.data("bounds")),$.each(a.data("subregions")||[],function(a,c){var d=new OpenLayers.Bounds(c.extent);$("<option>",{value:c.abbr,text:c.name}).data("bounds",d).appendTo("#subregion")}),1<$("#subregion option").length?($("#subregion").slideDown("fast",function(){$("label[for=subregion]").css("overflow","visible")}),$("label[for=subregion]").slideDown("fast",
function(){$("label[for=subregion]").css("overflow","visible")})):($("#subregion").slideUp("fast",function(){$("label[for=subregion]").css("overflow","visible")}),$("label[for=subregion]").slideUp("fast",function(){$("label[for=subregion]").css("overflow","visible")})),$("#subregion").change())});$("#subregion").change(function(){var a=$("#subregion option:selected");if(0!=a.length){var b=a.data("bounds");map.setCenter(b.getCenterLonLat(),map.getZoomForExtent(b),!1,!0);ocean.area=a.val()}})}});jQuery.extend({Controller:function(c,a){c.addListener(a.getModelListener())}});$.DropdownView.prototype=new $.View;$.VariableDropdownView.prototype=new $.DropdownView;$.VariableModel.prototype=new $.Model;$.RegionCountryModel.prototype=new $.Model;$.RegionCountryDropdownView.prototype=new $.DropdownView;
var variableDropdownView=new $.VariableDropdownView,variableModel=new $.VariableModel,variableController=new $.Controller(variableModel,variableDropdownView),regionCountryDropdownView=new $.RegionCountryDropdownView,regionCountryModel=new $.RegionCountryModel,regionCountryController=new $.Controller(regionCountryModel,regionCountryDropdownView),$fotoramaDiv=$(".fotorama").fotorama(),fotorama=$fotoramaDiv.data("fotorama");$.DropdownView.prototype=new $.View;$.VariableDropdownView.prototype=new $.DropdownView;$.VariableModel.prototype=new $.Model;$.RegionCountryModel.prototype=new $.Model;$.RegionCountryDropdownView.prototype=new $.DropdownView;variableDropdownView=new $.VariableDropdownView;variableModel=new $.VariableModel;variableController=new $.Controller(variableModel,variableDropdownView);regionCountryDropdownView=new $.RegionCountryDropdownView;regionCountryModel=new $.RegionCountryModel;
regionCountryController=new $.Controller(regionCountryModel,regionCountryDropdownView);$fotoramaDiv=$(".fotorama").fotorama();fotorama=$fotoramaDiv.data("fotorama");
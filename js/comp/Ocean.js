jQuery.extend({HashTable:function(){var a=[];this.toArray=function(){var b=[],c;for(c in a)b.push(a[c]);return b};this.put=function(b,c){a[b]=c};this.clear=function(b){delete a[b]};this.get=function(b){return a[b]}}});$.extend({Model:function(a){var b=this;b.cache=null;b.lastLoad=null;b.listeners=[];b.url=a;b.getData=function(){};b.clearAll=function(){cache=null};b.addListener=function(a){b.listeners.push(a)};b.notifyLoadBegin=function(){$.each(b.listeners,function(a){b.listeners[a].loadBegin()})};b.notifyLoadFinish=function(a){$.each(b.listeners,function(d){b.listeners[d].loadFinish(a)})};b.notifyLoadFail=function(){$.each(b.listeners,function(a){b.listeners[a].loadFail()})};b.notifyModelChanged=function(){$.each(b.listeners,
function(a){b.listeners[a].modelChanged()})};this.ModelListener=function(a){return $.extend({loadBegin:function(){},loadFail:function(){},loadFinish:function(a){},modelChanged:function(a){}},a)}}});jQuery.extend({VariableModel:function(){var a=this;a.varGroupUrl="config/comp/vargroups.json";a.datasetsUrl="config/comp/datasets.json";a.appModel=new $.AppModel;this.getData=function(){a.notifyLoadBegin();$.when($.getJSON(a.varGroupUrl),$.getJSON(a.datasetsUrl),a.appModel.getData()).done(function(b,c,d){a.variableCache=b[0];a.datasetCache=c[0];a.appModel.setApp(window.location.hash.split("#")[1]);a.filterVariable();a.notifyLoadFinish($.extend({},{variable:a.variableFiltered},{datasets:c[0]}))}).fail(function(){a.notifyLoadFail();
fatal_error("Failed to load portal variable configuration")})};a.filterVariable=function(){a.variableFiltered={};$.each(a.appModel.getApp().vargroups,function(b,c){a.variableFiltered[c]=a.variableCache[c]})}}});jQuery.extend({View:function(){function a(){var a=this.addform.find(".subject").val(),c=this.addform.find(".body").val();0==a.length?alert("Please enter a subject for your note"):that.notifyNewNote(a,c);return!1}this.doms=new $.HashTable;this.listeners=[];$notes=$("#ui #notes ul");this.addform=$("#controlPanel");this.addform.submit(a);this.addform.find("#submit").click(a);this.showAddForm=function(){$editform.hide();this.addform.show();this.addform.find(".subject").focus()};this.setAddFormEnabled=
function(a){var c=this.addform;a?c.find(".input").removeAttr("DISABLED"):c.find(".input").attr("DISABLED","1")};this.clearAddForm=function(){this.addform.find(".input").val("");this.addform.find(".subject").focus()};this.loadNote=function(a){var c=doms.get(a.getId());c?c.refresh():(c=new $.NoteLI(a,that.showEditForm),doms.put(a.getId(),c),$notes.append(c.getDOM()))};this.showNote=function(a,c){var d=doms.get(a);d&&(c?$(d.getDOM()).show():$(d.getDOM()).hide())};this.flushNote=function(a){var c=doms.get(a);
c&&$(c.getDOM()).remove();doms.clear(a)};this.addListener=function(a){this.listeners.push(a)};this.notifyDeleteNote=function(a){$.each(listeners,function(c){listeners[c].deleteNoteClicked(a)})};this.ModelListener=function(a){return $.extend({loadBegin:function(){},loadFail:function(){},loadFinish:function(a){},modelChanged:function(a){}},a)}}});jQuery.extend({NoteOption:function(a,b){var c=$("<option></option>");c.click(function(){b(a)});this.getNote=function(){return a};this.refresh=function(){c.text(a.getSubject())};this.getDOM=function(){return c};this.refresh()},DropdownView:function(){this.id="";this.getModelListener=function(){}}});jQuery.extend({VariableDropdownView:function(){var a=this;a.id="variable";a.updateView=function(a){var c={};$.each(a.variable,function(a,b){$("<optgroup>",{id:a,label:b.name}).appendTo("#variable");$.each(b.vars,function(b,g){c[g]=a})});ocean.datasets={};ocean.variables={};$.each(a.datasets,function(a,b){ocean.datasets[b.id]=b;$.each(b.variables,function(a,c){ocean.variables[c.id]||(ocean.variables[c.id]={name:c.name,plots:{},variable:c});$.each(c.plottypes,function(a,d){ocean.variables[c.id].plots[d]||
(ocean.variables[c.id].plots[d]={});$.each(c.periods,function(a,e){ocean.variables[c.id].plots[d][e]||(ocean.variables[c.id].plots[d][e]=[]);ocean.variables[c.id].plots[d][e].push(b.id)})})})});$.each(ocean.variables,function(a,b){var e;a in c&&(e=$("#variable optgroup#"+c[a]),0==e.length&&(e=$("#variable")));$("<option>",{text:b.name,value:a}).appendTo(e)})};a.getModelListener=function(){return a.ModelListener({loadFinish:a.updateView,modelChanged:function(b){$("#variable").empty();a.updateView(b)}})}}});jQuery.extend({RegionCountryModel:function(){var a=this;a.regionsUrl="cgi/regions.py";a.portalUrl="config/comp/portals.json";this.getData=function(){a.notifyLoadBegin();$.when($.getJSON(a.regionsUrl,{portal:ocean.config}),$.getJSON(a.portalUrl)).done(function(b,c){a.notifyLoadFinish({regions:b,portal:c})}).fail(function(){this.notifyLoadFail();fatal_error("Failed to load portal regions configuration")})}}});jQuery.extend({RegionCountryDropdownView:function(){var a=this;a.id="variable";a.getModelListener=function(){return a.ModelListener({loadFinish:function(a){var c=a.regions[0];ocean.configProps=a.portal[0][ocean.config];if(ocean.configProps){document.title=ocean.configProps.name+" Ocean Application";var d;$.each(c,function(a,b){var c=L.latLngBounds([[b.extent[1],b.extent[0]],[b.extent[3],b.extent[2]]]);b.parent||($("<option>",{value:b.abbr,text:b.name}).data("extent",c).appendTo("#region"),d?d.extend(c):
d=L.latLngBounds(c.getSouthWest(),c.getNorthEast()))});map.fitBounds(d);$.each(c,function(a,b){if(b.parent){var c=$('#region option[value="'+b.parent+'"]'),d=c.data("subregions")||[];d.push(b);c.data("subregions",d)}});setValue("region",ocean.config)}else fatal_error("No portal called '"+ocean.config+"'.")}})};$("#region").change(function(){var a=$("#region option:selected");0!=a.length&&($("#subregion option").remove(),$("<option>",{text:"Whole Region",value:a.val(),selected:!0}).appendTo("#subregion").data("bounds",
a.data("extent")),$.each(a.data("subregions")||[],function(a,b){var f=L.latLngBounds([[b.extent[1],b.extent[0]],[b.extent[3],b.extent[2]]]);$("<option>",{value:b.abbr,text:b.name}).data("bounds",f).appendTo("#subregion")}),1<$("#subregion option").length?$(".subregion").slideDown("fast"):$(".subregion").slideUp("fast"),$("#subregion").change())});$("#subregion").change(function(){var a=$("#subregion option:selected");if(0!=a.length&&(ocean.area=a.val(),a=a.data("bounds"),map.fitBounds(a),ocean.dataset))ocean.dataset.onRegionChange()})}});jQuery.extend({Controller:function(a,b){a.addListener(b.getModelListener())}});jQuery.extend({AppModel:function(){var a=this;a.appUrl="config/comp/app.json";a.getData=function(){return $.when($.getJSON(a.appUrl)).then(function(b){a.cache=b;return a.cache})};a.setApp=function(b){a.app=b};a.getApp=function(){return a.cache[a.app]}}});jQuery.extend({SeaLevelModel:function(){var a=this;a.appUrl="config/comp/tidegauges.geojson";a.getData=function(){return $.when($.getJSON(a.appUrl)).then(function(b){a.cache=b;return a.cache})};a.getTideGauges=function(){return a.cache};a.selectTideGauge=function(b){a.selectedTideGauge=b};a.getSelectedTideGaugeId=function(){return a.selectedTideGauge};a.getSelectedTideGaugeLat=function(){}}});$.DropdownView.prototype=new $.View;$.VariableDropdownView.prototype=new $.DropdownView;$.VariableModel.prototype=new $.Model;$.RegionCountryModel.prototype=new $.Model;$.RegionCountryDropdownView.prototype=new $.DropdownView;$.AppModel.prototype=new $.Model;$.SeaLevelModel.prototype=new $.Model;
var variableDropdownView=new $.VariableDropdownView,variableModel=new $.VariableModel,variableController=new $.Controller(variableModel,variableDropdownView),regionCountryDropdownView=new $.RegionCountryDropdownView,regionCountryModel=new $.RegionCountryModel,regionCountryController=new $.Controller(regionCountryModel,regionCountryDropdownView),$fotoramaDiv=$(".fotorama").fotorama(),fotorama=$fotoramaDiv.data("fotorama");
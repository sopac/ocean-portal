jQuery.extend({HashTable:function(){var b=[];this.toArray=function(){var a=[],c;for(c in b)a.push(b[c]);return a};this.put=function(a,c){b[a]=c};this.clear=function(a){delete b[a]};this.get=function(a){return b[a]}}});$.extend({Model:function(b){var a=this;a.cache=null;a.lastLoad=null;a.listeners=[];a.url=b;a.getData=function(){};a.clearAll=function(){cache=null};a.addListener=function(c){a.listeners.push(c)};a.notifyLoadBegin=function(){$.each(a.listeners,function(c){a.listeners[c].loadBegin()})};a.notifyLoadFinish=function(c){$.each(a.listeners,function(b){a.listeners[b].loadFinish(c)})};a.notifyLoadFail=function(){$.each(a.listeners,function(c){a.listeners[c].loadFail()})};a.notifyModelChanged=function(){$.each(a.listeners,
function(c){a.listeners[c].modelChanged()})};this.ModelListener=function(a){return $.extend({loadBegin:function(){},loadFail:function(){},loadFinish:function(a){},modelChanged:function(a){}},a)}}});jQuery.extend({VariableModel:function(){var b=this;b.varGroupUrl="config/comp/vargroups.json";b.datasetsUrl="config/comp/datasets.json";b.appUrl="config/comp/app.json";this.getData=function(){b.notifyLoadBegin();$.when($.getJSON(b.varGroupUrl),$.getJSON(b.datasetsUrl),$.getJSON(b.appUrl)).done(function(a,c,d){b.variableCache=a[0];b.datasetCache=c[0];b.appCache=d[0];b.filterVariable();b.notifyLoadFinish($.extend({},{variable:b.variableFiltered},{datasets:c[0]}))}).fail(function(){this.notifyLoadFail();
fatal_error("Failed to load portal variable configuration")})};b.filterVariable=function(){b.variableFiltered={};$.each(b.variableCache,function(a,c){-1<$.inArray(a,b.appCache[window.location.hash.split("#")[1]].vargroups)&&(b.variableFiltered[a]=c)})}}});jQuery.extend({View:function(){function b(){var a=this.addform.find(".subject").val(),b=this.addform.find(".body").val();0==a.length?alert("Please enter a subject for your note"):that.notifyNewNote(a,b);return!1}this.doms=new $.HashTable;this.listeners=[];$notes=$("#ui #notes ul");this.addform=$("#controlPanel");this.addform.submit(b);this.addform.find("#submit").click(b);this.showAddForm=function(){$editform.hide();this.addform.show();this.addform.find(".subject").focus()};this.setAddFormEnabled=
function(a){var b=this.addform;a?b.find(".input").removeAttr("DISABLED"):b.find(".input").attr("DISABLED","1")};this.clearAddForm=function(){this.addform.find(".input").val("");this.addform.find(".subject").focus()};this.loadNote=function(a){var b=doms.get(a.getId());b?b.refresh():(b=new $.NoteLI(a,that.showEditForm),doms.put(a.getId(),b),$notes.append(b.getDOM()))};this.showNote=function(a,b){var d=doms.get(a);d&&(b?$(d.getDOM()).show():$(d.getDOM()).hide())};this.flushNote=function(a){var b=doms.get(a);
b&&$(b.getDOM()).remove();doms.clear(a)};this.addListener=function(a){this.listeners.push(a)};this.notifyDeleteNote=function(a){$.each(listeners,function(b){listeners[b].deleteNoteClicked(a)})};this.ModelListener=function(a){return $.extend({loadBegin:function(){},loadFail:function(){},loadFinish:function(a){},modelChanged:function(a){}},a)}}});jQuery.extend({NoteOption:function(b,a){var c=$("<option></option>");c.click(function(){a(b)});this.getNote=function(){return b};this.refresh=function(){c.text(b.getSubject())};this.getDOM=function(){return c};this.refresh()},DropdownView:function(){this.id="";this.getModelListener=function(){}}});jQuery.extend({VariableDropdownView:function(){var b=this;b.id="variable";b.updateView=function(a){var b={};$.each(a.variable,function(a,f){$("<optgroup>",{id:a,label:f.name}).appendTo("#variable");$.each(f.vars,function(f,g){b[g]=a})});ocean.datasets={};ocean.variables={};$.each(a.datasets,function(a,b){ocean.datasets[b.id]=b;$.each(b.variables,function(a,c){ocean.variables[c.id]||(ocean.variables[c.id]={name:c.name,plots:{},variable:c});$.each(c.plottypes,function(a,d){ocean.variables[c.id].plots[d]||
(ocean.variables[c.id].plots[d]={});$.each(c.periods,function(a,e){ocean.variables[c.id].plots[d][e]||(ocean.variables[c.id].plots[d][e]=[]);ocean.variables[c.id].plots[d][e].push(b.id)})})})});$.each(ocean.variables,function(a,f){var e;a in b&&(e=$("#variable optgroup#"+b[a]),0==e.length&&(e=$("#variable")));$("<option>",{text:f.name,value:a}).appendTo(e)})};b.getModelListener=function(){return b.ModelListener({loadFinish:b.updateView,modelChanged:function(a){$("#variable").empty();b.updateView(a)}})}}});jQuery.extend({RegionCountryModel:function(){var b=this;b.regionsUrl="cgi/regions.py";this.getData=function(){b.notifyLoadBegin();$.when($.getJSON(b.regionsUrl,{portal:"pac"})).done(function(a){b.notifyLoadFinish({regions:a})}).fail(function(){this.notifyLoadFail();fatal_error("Failed to load portal regions configuration")})}}});jQuery.extend({RegionCountryDropdownView:function(){var b=this;b.id="variable";b.getModelListener=function(){return b.ModelListener({loadFinish:function(a){a=a.regions;$.each(a,function(a,b){b.parent||$("<option>",{value:b.abbr,text:b.name}).data("extent",b.extent).appendTo("#region")});$.each(a,function(a,b){if(b.parent){var f=$('#region option[value="'+b.parent+'"]'),e=f.data("subregions")||[];e.push(b);f.data("subregions",e)}})}})};$("#region").change(function(){var a=$("#region option:selected");
0!=a.length&&($("#subregion option").remove(),$("<option>",{text:"Whole Region",value:a.val(),selected:!0}).appendTo("#subregion").data("bounds",a.data("bounds")),$.each(a.data("subregions")||[],function(a,b){var f=new OpenLayers.Bounds(b.extent);$("<option>",{value:b.abbr,text:b.name}).data("bounds",f).appendTo("#subregion")}),1<$("#subregion option").length?($("#subregion").slideDown("fast",function(){$("label[for=subregion]").css("overflow","visible")}),$("label[for=subregion]").slideDown("fast",
function(){$("label[for=subregion]").css("overflow","visible")})):($("#subregion").slideUp("fast",function(){$("label[for=subregion]").css("overflow","visible")}),$("label[for=subregion]").slideUp("fast",function(){$("label[for=subregion]").css("overflow","visible")})),$("#subregion").change())});$("#subregion").change(function(){var a=$("#subregion option:selected");if(0!=a.length){var b=a.data("bounds");map.setCenter(b.getCenterLonLat(),map.getZoomForExtent(b),!1,!0);ocean.area=a.val()}})}});jQuery.extend({Controller:function(b,a){b.addListener(a.getModelListener())}});$.DropdownView.prototype=new $.View;$.VariableDropdownView.prototype=new $.DropdownView;$.VariableModel.prototype=new $.Model;$.RegionCountryModel.prototype=new $.Model;$.RegionCountryDropdownView.prototype=new $.DropdownView;
var variableDropdownView=new $.VariableDropdownView,variableModel=new $.VariableModel,variableController=new $.Controller(variableModel,variableDropdownView),regionCountryDropdownView=new $.RegionCountryDropdownView,regionCountryModel=new $.RegionCountryModel,regionCountryController=new $.Controller(regionCountryModel,regionCountryDropdownView),$fotoramaDiv=$(".fotorama").fotorama(),fotorama=$fotoramaDiv.data("fotorama");